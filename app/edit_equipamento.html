<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Editar Equipamento</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }
    .container {
      max-width: 500px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
    h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #2196F3;
    }
    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }
    input, textarea, select {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    button {
      width: 100%;
      padding: 10px;
      margin-top: 15px;
      background: #2196F3;
      color: white;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background: #1976D2;
    }
    .msg {
      margin-top: 15px;
      text-align: center;
      font-weight: bold;
    }
    .botao-voltar {
      display: block;
      text-align: center;
      margin-top: 10px;
      background: #4CAF50;
      padding: 10px;
      color: white;
      text-decoration: none;
      border-radius: 5px;
    }
    .botao-voltar:hover {
      background: #388E3C;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Editar Equipamento</h2>
    <form id="formEquipamento">
      <label>ID do Cliente:</label>
      <input type="number" id="client_id" required />

      <label>Descrição:</label>
      <textarea id="description" required></textarea>

      <label>Modelo:</label>
      <input type="text" id="model" required />

      <label>Serial:</label>
      <input type="text" id="serial" required />

      <label>Marca:</label>
      <input type="text" id="brand" required />

      <label>Defeito:</label>
      <textarea id="defect_defect_for_repair" required></textarea>

      <label>Preço:</label>
      <input type="number" step="0.01" id="price" required />

      <label>Entregue:</label>
      <select id="entregue">
        <option value="true">Sim</option>
        <option value="false">Não</option>
      </select>

      <label>Garantia:</label>
      <select id="garantia">
        <option value="true">Sim</option>
        <option value="false">Não</option>
      </select>

      <button id="botao"  type="submit">Salvar Alterações</button>
    </form>

    <div class="msg" id="mensagem"></div>
    <a class="botao-voltar" href="https://sftcode.com/app/main.html">⬅ Voltar para a Tela Principal</a>
  </div>

  <script>
  
  var departure_date = "0000-00-00 00:00:00.000000";
    function toggleSalvar() {
      const entregue = document.getElementById("entregue").value;
      const botaoSalvar = document.querySelector("button[type='submit']");
      botaoSalvar.disabled = (entregue === "true");
    }

    function toggleCampos() {
      const entregue = document.getElementById("entregue").value;
      const form = document.getElementById("formEquipamento");
      const elementos = form.querySelectorAll("input, textarea, select ");

      elementos.forEach(el => {
          
        if (el.id !== "entregue") { 
          el.disabled = (entregue === "true");
        }
      });
    }

    document.getElementById("entregue").addEventListener("change", () => {
      toggleCampos();
 
    });

    const params = new URLSearchParams(window.location.search);
    const idEquipamento = params.get("client_id");
    let idMEu = 0;

    if (!idEquipamento) {
      alert("ID do equipamento não informado!");
    } else {
      fetch("https://sftcode.com/controller/equipment_controller_web_find_by_id.php?id=" + idEquipamento)
        .then(res => res.json())
        .then(data => {
          idMEu = data.id;
          departure_date = data.departure_date;
          document.getElementById("client_id").value = data.client_id;
          document.getElementById("description").value = data.description;
          document.getElementById("model").value = data.model;
          document.getElementById("serial").value = data.serial;
          document.getElementById("brand").value = data.brand;
          document.getElementById("defect_defect_for_repair").value = data.defect_defect_for_repair;
          document.getElementById("price").value = data.price;
          document.getElementById("entregue").value = data.entregue ? "true" : "false";
          document.getElementById("garantia").value = data.garantia ? "true" : "false";
       console.log("departure");
       console.log(this.departure_date);

       
          
       
       console.log("aqui aqui auqi");
       console.log(data.departure_date);
          toggleCampos();
          
        })
        .catch(err => {
          console.error("Erro ao carregar equipamento:", err);
          alert("Erro ao carregar os dados!");
        });
    }

    document.getElementById("formEquipamento").addEventListener("submit", function (e) {
      e.preventDefault();

      const dados = new URLSearchParams();
      dados.append("id", idMEu);
      dados.append("departure_date", departure_date==null?"0000-00-00 00:00:00.000000":departure_date);
      dados.append("client_id", document.getElementById("client_id").value);
      dados.append("description", document.getElementById("description").value);
      dados.append("model", document.getElementById("model").value);
      dados.append("serial", document.getElementById("serial").value);
      dados.append("brand", document.getElementById("brand").value);
      dados.append("defect_defect_for_repair", document.getElementById("defect_defect_for_repair").value);
      dados.append("price", parseFloat(document.getElementById("price").value));
      dados.append("entregue", document.getElementById("entregue").value === "true" ? 1 : 0);
      dados.append("garantia", document.getElementById("garantia").value);

      fetch("https://sftcode.com/controller/equipment_controller_web_update.php", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: dados
      })
      .then(res => {
  console.log("Código de resposta:", res.status); // <- AQUI PEGA O STATUS
  if (!res.ok) {
    // Se o status for 400, 500 etc, lança erro
    throw new Error(`Erro do servidor: ${res.status}`);
  }
  return res.text(); // ou res.json() se o backend retornar JSON
})
.then(data => {})
      .then(() => {
        console.log("aquiiiii!!!!!");
       console.log(departure_date);
       
      
    //   if (!res.ok) {
    // // // Se o servidor retornar erro (400, 500, etc)
    // //          const mensagemErro = resposta?.error || "Erro ao atualizar equipamento!";
    //       throw new Error(mensagemErro); 
    //      }
    
       
        document.getElementById("mensagem").innerText = "✅ Equipamento atualizado com sucesso!";
        document.getElementById("mensagem").style.color = "green";
        
     
      })
      .catch(() => {
        document.getElementById("mensagem").innerText = "❌ Erro ao atualizar equipamento!";
        document.getElementById("mensagem").style.color = "red";
      });
    });
  </script>
</body>
</html>
